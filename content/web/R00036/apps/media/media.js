class Media{constructor(e){this.xConfig={name:"Media Player",channel:10001,origin:"https://rxat.ro"},this.link=e,this.userId=0,this.player=null,this.playing=null,this.videosCue=[],this.thumbsCue=[],this.lockCast=!1,this.DebugMode=!1,this.connected=!1,this.lock=document.querySelector("#lock"),this.video=document.querySelector("#video"),this.addVideo=document.querySelector("#addVideo"),this.thumbnails=document.querySelectorAll("[data-thumb=true]"),this.thumbnails.forEach((e=>{addToolTip(e,"Click to play",!1,"low"),e.addEventListener("click",(()=>{let i=e.dataset.videoId;if(i){let e={videoId:i,startSeconds:0};this.playVideo(e)}}));let i=e.querySelector(".cast");addToolTip(i,"Click to broadcast",!1,"low"),i.addEventListener("click",(i=>{let t=e.dataset.videoId;if(t){let e={videoId:t,startSeconds:0};this.clearVideosCue(),this.cueVideo(e),this.playVideo(e),this.SendMedia({type:"cast",videoId:t}),i.stopPropagation()}return!1}))})),this.addVideo.addEventListener("click",(()=>{if(this.video.value.length>0){let e=this.getVideoData(this.video.value.trim());e&&(this.videosCue.length>0?this.cueVideo(e):this.playVideo(e),this.video.value="",this.cueThumbnail(e))}})),this.lock.addEventListener("change",(()=>{this.lockCast=this.lock.checked,localStorage.setItem(this.xConfig.channel,this.lockCast?1:0)})),parseInt(localStorage.getItem(this.xConfig.channel))&&(this.lockCast=!0,this.lock.checked=!0),parent.addEventListener("message",this.onMessage.bind(this),!1),window.addEventListener("beforeunload",(()=>{this.Send(0,0,0)}));let i=0;this.Tick=setInterval((()=>{!this.connected&&i%12==0&&i<450&&this.Send(1,0,""),i++}),83),window.onYouTubeIframeAPIReady=()=>{if(this.link){let e=this.getVideoData(this.link);e&&(this.playVideo(e),this.cueThumbnail(e))}}}Send(e,i,t){this.Trace(["Send = ",e,i,t]);let s={from:this.xConfig.name,channel:e,user:i,msg:t,tobox:1};parent.postMessage(JSON.stringify(s),this.xConfig.origin)}Receive(e,i,t){if(this.Trace(["Receive = ",e,i,t]),1==e&&(this.connected=!0,this.Send(this.xConfig.channel,0,""),this.Send(4,0,"l"),this.Send(6,0,0),this.Trace(this.xConfig.name+" connected!"),clearInterval(this.Tick)),6==e&&(this.userId=i),e==this.xConfig.channel&&(t=this.Decode(t))&&"cast"==t.type&&!this.lockCast){let e={videoId:t.videoId,startSeconds:0};this.clearVideosCue(),this.cueVideo(e),this.cueThumbnail(e),this.playVideo(this.videosCue[0])}if(4==e){let e=t.trim().split(" "),i=null;for(let t=0;t<e.length;t++)if(-1!=e[t].indexOf("youtu.be/")||-1!=e[t].indexOf("youtube.com/watch?")){i=e[t];break}if(i){let e=this.getVideoData(i);e&&this.cueThumbnail(e)}}}cueThumbnail(e){this.thumbsCue.unshift(e),this.thumbsCue.slice(0,3).forEach(((e,i)=>{this.thumbnails[i].dataset.videoId=e.videoId,this.thumbnails[i].style.backgroundImage="url(https://img.youtube.com/vi/"+e.videoId+"/default.jpg)"}))}clearVideosCue(){this.videos=[],this.playing=null}cueVideo(e){this.videosCue.push(e)}playVideo(e){this.player?e.playlistId?this.player.loadPlaylist({list:e.playlistId,listType:"playlist",index:e.playlistIndex,startSeconds:e.videoStart}):this.player.loadVideoById(e.videoId,e.videoStart):this.player=new YT.Player("player",{width:"425",height:"355",events:{onReady:i=>{e.playlistId?this.player.loadPlaylist({list:e.playlistId,listType:"playlist",index:e.playlistIndex,startSeconds:e.videoStart}):this.player.loadVideoById(e.videoId,e.videoStart)},onError:e=>{this.videosCue[0]===this.playing&&this.videosCue.shift();let i=this.videosCue[0];this.videosCue.length>0&&(i.playlistId?this.player.loadPlaylist({list:i.playlistId,listType:"playlist",index:i.playlistIndex,startSeconds:i.videoStart}):this.player.loadVideoById(i.videoId,i.videoStart),this.playing=i)},onStateChange:this.onVideoEnded.bind(this)}}),this.playing=e,this.videosCue.includes(e)||this.cueVideo(e)}onVideoEnded(e){e.data==YT.PlayerState.ENDED&&(this.videosCue.length>1&&this.videosCue.includes(this.playing)?(this.videosCue[0]===this.playing&&this.videosCue.shift(),this.playVideo(this.videosCue[0])):this.clearVideosCue())}getVideoData(e){if(-1!=e.indexOf("youtu.be/")||-1!=e.indexOf("youtube.com/watch?")&&-1!=e.indexOf("v=")){let i=null,t=0,s=null,d=0;return i=-1!=e.indexOf("youtu.be/")?e.split(".be/")[1].split("?")[0]:e.split("v=")[1].split("＆")[0].split("&")[0],-1!=e.indexOf("t=")&&(t=parseInt(e.split("t=")[1].split("＆")[0].split("&")[0])),-1!=e.indexOf("list=")&&(s=e.split("list=")[1].split("＆")[0].split("&")[0],-1!=e.indexOf("index=")&&(d=e.split("index=")[1].split("＆")[0].split("&")[0]-1)),{videoId:i,videoStart:t,playlistId:s,playlistIndex:d}}return null}SendMedia(e){this.Send(this.xConfig.channel,0,this.Encode(e))}onMessage(e){if(e.origin!==this.xConfig.origin)return void this.Trace(["onMessage Bad Origin = ",e.origin,e]);let i=JSON.parse(e.data);this.Receive(i.channel,parseInt(i.user),i.msg)}Encode(e){return LZString.compressToBase64(JSON.stringify(e))}Decode(e){return JSON.parse(LZString.decompressFromBase64(e))}Trace(e){if(!this.DebugMode)return;let i=e;Array.isArray(i)&&(i=i.join(" ")),console.log(i)}}