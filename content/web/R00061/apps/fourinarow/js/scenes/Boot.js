"use strict";function _inheritsLoose(a,b){a.prototype=Object.create(b.prototype);a.prototype.constructor=a;a.__proto__=b}var Boot=function(a){_inheritsLoose(b,a);function b(){var b;b=a.call(this,{key:"Boot"})||this;b.xConfig={channel:20010,name:"Four In A Row",origin:"https://rxat.ro"};b.ready=!0;b.player=null;b.currentTab=0;b.opponent=null;b.playing=!1;b.connected=!1;b.DebugMode=!1;b.MenuEvents=null;b.MainEvents=null;b.gameOver=!1;return b}var c=b.prototype;c.create=function create(){var a=this;this.events.on("send",this.Send,this);this.events.on("trace",this.Trace,this);this.events.on("sendGame",this.SendGameData,this);this.events.on("doReset",this.doReset,this);this.events.on("setPlaying",this.setPlaying,this);this.events.on("setReady",this.setReady,this);this.MenuEvents=this.scene.get("Menu").events;this.MainEvents=this.scene.get("Main").events;this.GameOverEvents=this.scene.get("GameOver").events;window.addEventListener("message",this.onMessage.bind(this),!1);window.addEventListener("beforeunload",function(){a.SendGameData({from:a.player,to:a.opponent,type:"quit",user:a.player})});var b=0;this.Tick=setInterval(function(){if(!a.connected&&0==b%12&&450>b)a.Send(1,0,"");b++},83)};c.doReset=function doReset(){this.opponent=null;this.playing=!1;this.gameOver=!1};c.setPlaying=function setPlaying(){this.playing=!0;this.gameOver=!1};c.setReady=function setReady(a){this.ready=a};c.SendGameData=function SendGameData(a){this.Send(this.xConfig.channel,a.to,a)};c.Send=function Send(a,b,c){this.Trace(["Send = ",a,b,c]);var d={from:this.xConfig.name,channel:a,user:b,msg:this.Encode(c),tobox:1};parent.postMessage(JSON.stringify(d),this.xConfig.origin)};c.Receive=function Receive(a,b,c){this.Trace(["Receive = ",a,b,c]);if(1==a){this.connected=!0;this.Send(6,0,0);this.Trace(this.xConfig.name+" connected!");clearInterval(this.Tick)}if(6==a){this.player=b;this.scene.launch("Preload",{player:this.player})}if(2==a){this.currentTab=b;if(this.playing)return;if(0==this.currentTab){this.ready=!1;this.MenuEvents.emit("doReset",0)}else if(!this.playing&&!this.gameOver){this.ready=!0}if(this.opponent&&this.currentTab!=this.opponent&&!this.gameOver){this.SendGameData({from:this.player,to:this.opponent,type:"quit",user:this.player});this.MenuEvents.emit("doReset",0);this.doReset()}if(0!=b&&this.opponent!=b&&!this.gameOver){this.Send(this.xConfig.channel,b,"ok?")}else{this.doReset();this.MenuEvents.emit("doReset",0);this.MenuEvents.emit("onTabChanged",0)}this.MenuEvents.emit("onTabChanged",b)}if(a==this.xConfig.channel){c=this.Decode(c);if("ok"==c&&!this.opponent){this.opponent=b;this.MenuEvents.emit("onUserOk",b);this.Send(this.xConfig.channel,b,"ok")}if("ok?"==c&&!this.playing&&!this.gameOver&&this.ready&&0!=this.currentTab){if(this.currentTab==b&&(!this.opponent||this.opponent&&this.opponent==b)&&!this.playing&&!this.gameOver&&this.ready){this.Send(this.xConfig.channel,b,"ok")}}if(c.type&&parseInt(c.from)==this.opponent&&parseInt(c.to)==this.player){switch(c.type){case"start":this.ready=!1;this.playing=!0;this.gameOver=!1;this.scene.stop(c.scene);this.scene.start("Main",{player:this.player,opponent:this.opponent,turn:c.turn});case"token":this.MainEvents.emit("tokens",[c.playerToken,c.opponentToken]);break;case"turn":this.MainEvents.emit("turn",parseInt(c.turn));break;case"move":this.MainEvents.emit("move",c.move);break;case"win":if(parseInt(c.win)==this.player){this.MainEvents.emit("win")}else{this.MainEvents.emit("lose")}this.gameOver=!0;this.playing=!1;break;case"draw":this.MainEvents.emit("draw");break;case"reset":this.MainEvents.emit("reset");break;case"quit":this.opponent=null;if(this.gameOver){this.GameOverEvents.emit("quit",c.user)}else if(this.playing){this.MainEvents.emit("quit",c.user,!0)}else{this.MenuEvents.emit("quit",c.user,!0)}break;}}}};c.onMessage=function onMessage(a){if(a.origin!==this.xConfig.origin){this.Trace(["onMessage Bad Origin = ",a.origin,a]);return}var b=JSON.parse(a.data);this.Receive(b.channel,parseInt(b.user),b.msg)};c.Encode=function Encode(a){return LZString.compressToBase64(JSON.stringify(a))};c.Decode=function Decode(a){return JSON.parse(LZString.decompressFromBase64(a))};c.Trace=function Trace(a){if(!this.DebugMode)return;var b=a;if(Array.isArray(b))b=b.join(" ");console.log(b)};return b}(Phaser.Scene);
