"use strict";function _inheritsLoose(a,b){a.prototype=Object.create(b.prototype);a.prototype.constructor=a;a.__proto__=b}var Main=function(a){_inheritsLoose(b,a);function b(){var b;b=a.call(this,{key:"Main"})||this;b.channel=20010;return b}var c=b.prototype;c.init=function init(a){this.board=[[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]];this.boardTokens=[[],[],[],[],[],[]];this.moves=[];this.sign=null;this.tokens=null;this.gameOver=!1;this.winTokens=[];this.lastToken=null;this.playerToken=null;this.opponentToken=null;this.turnText=null;this.timer=null;this.timeProgress=null;this.timeProgressBack=null;this.turn=a.turn;this.player=a.player;this.opponent=a.opponent;this.events.on("token",this.setTokens,this);this.events.on("turn",this.setTurns,this);this.events.on("move",this.setMoves,this);this.events.on("win",this.doWin,this);this.events.on("lose",this.doLose,this);this.events.on("draw",this.doDraw,this);this.events.on("reset",this.doReset,this);this.events.on("quit",this.doQuit,this);this.BootEvents=this.scene.get("Boot").events;this.BkgEvents=this.scene.get("Background").events;this.BootEvents.emit("setReady",!1);if(this.turn==this.player){this.turnText=this.add.dynamicBitmapText(this.cameras.main.centerX,this.cameras.main.height-30,"roboto","Your turn",24).setOrigin(.5)}else{this.turnText=this.add.dynamicBitmapText(this.cameras.main.centerX,this.cameras.main.height-27,"roboto","Opponent's turn",24).setOrigin(.5)}if(this.turn==this.player){this.playerToken=1;this.opponentToken=2}else{this.playerToken=2;this.opponentToken=1}};c.create=function create(){var a=this;this.BkgEvents.emit("change",0);var b=this.scene.get("Background");b.changeBackground(0);this.tokens=this.add.container(0,0);var c=this.add.sprite(this.cameras.main.centerX,this.cameras.main.centerY,"grid");var d=function _loop(b){var c=new Phaser.Geom.Rectangle(20+80*b,60,80,480);var d=a.add.graphics({fillStyle:{color:0,alpha:0}});d.fillRectShape(c);d.setInteractive({hitArea:c,hitAreaCallback:Phaser.Geom.Rectangle.Contains,useHandCursor:!0});d.on("pointerover",function(){if(a.sign){if(0==a.sign.alpha)a.sign.x=60+80*b;a.tweens.add({targets:a.sign,x:60+80*b,alpha:.25,duration:150,ease:"Cubic.easeOut"})}else{a.sign=a.add.sprite(60+80*b,30,"sign").setBlendMode(Phaser.BlendModes.SCREEN).setAlpha(.25)}});d.on("pointerout",function(){if(a.sign){a.tweens.add({targets:a.sign,alpha:0,duration:150,ease:"Cubic.easeOut"})}});d.on("pointerdown",function(){if(a.gameOver||a.turn!=a.player)return;var c=a.getLastEmptyCell(b);if(0<=c){a.board[c][b]=a.playerToken;if(a.lastToken)a.lastToken.stopEmitter();a.lastToken=a.addToken(a.playerToken,c,b);a.boardTokens[c][b]=a.lastToken;a.moves.push([c,b]);a.SendGame({type:"move",move:[c,b]});a.switchTurn()}})};for(var g=0;7>g;g++){d(g)}var e=new Button(this,20,this.cameras.main.height-53,"resetButton",function(){if(a.turn==a.player&&0<a.tokens.getAll().length){var b=new Dialog(a,a.cameras.main.centerX,a.cameras.main.centerY,"Are you sure you want\nto reset the game?","resetButton",function(){a.SendGame({type:"reset"});a.doReset();a.switchTurn()})}}).setOrigin(0);var f=new Button(this,this.cameras.main.width-20,this.cameras.main.height-1,"leaveButton",function(){var b=new Dialog(a,a.cameras.main.centerX,a.cameras.main.centerY,"Are you sure you want\nto leave the game?","leaveButton",function(){a.SendGame({type:"quit",user:a.player});a.doQuit(a.opponent)})}).setOrigin(1);if(this.turn==this.player)this.setTurnCounter(30)};c.addToken=function addToken(a,b,c){var d=this;if(this.gameOver)return;var e=new Token(this,29+80*c,0,a-1).setOrigin(0).setAlpha(0);this.tokens.add(e);this.tokens.getAll().forEach(function(a){a.stopEmitter()});var f=this.tweens.timeline({tweens:[{targets:e,alpha:.5,ease:"Back.easeInOut",duration:60},{targets:e,alpha:1,y:69+80*b,ease:"Bounce.easeOut",duration:400*(b/4),onStart:function onStart(){e.startEmitter()},onComplete:function onComplete(){if(d.checkWinner()){d.winTokens.forEach(function(a){a.winEmitter()});if(d.checkWinner()==d.playerToken){d.doWin();d.updateGameStats(1,0);d.SendGame({type:"win",win:d.player})}else{d.doLose();d.updateGameStats(0,1);d.SendGame({type:"win",win:d.opponent})}d.gameOver=!0}else if(d.checkDraw()){d.doDraw();d.switchTurn();d.SendGame({type:"draw"})}}}]});return e};c.Encode=function Encode(a){return LZString.compressToBase64(JSON.stringify(a))};c.Decode=function Decode(a){return JSON.parse(LZString.decompressFromBase64(a))};c.loadGameStats=function loadGameStats(){var a=localStorage.getItem(this.channel);if(a)return this.Decode(a)};c.updateGameStats=function updateGameStats(a,b){var c=this.loadGameStats();if(!c)c={wins:0,loses:0};var d={wins:c.wins+a,loses:c.loses+b};localStorage.setItem(this.channel,this.Encode(d))};c.setTokens=function setTokens(a){this.playerToken=a[1];this.opponentToken=a[0]};c.setTurns=function setTurns(a){if(this.gameOver)return;this.turn=a;if(this.turn==this.player){this.setTurnCounter(30);this.turnText.text="Your turn"}else{this.turnText.setText("Opponent's turn").setY(this.cameras.main.height-27)}};c.setTurnCounter=function setTurnCounter(a){var b=this;var c=null;var d=a;if(this.timeProgress){clearInterval(this.timer);this.timer=null;this.timeProgress.destroy();this.timeProgress=null;this.timeProgressBack.destroy();this.timeProgressBack=null}this.timeProgress=this.add.graphics({fillStyle:{color:16382459,alpha:.5}}).setBlendMode(Phaser.BlendModes.ADD);this.timeProgressBack=this.add.graphics({fillStyle:{color:16382459,alpha:.25}}).setBlendMode(Phaser.BlendModes.ADD);this.timeProgress.fillRoundedRect(this.cameras.main.centerX-105,this.cameras.main.height-15,210,6,3);this.timeProgressBack.fillRoundedRect(this.cameras.main.centerX-105,this.cameras.main.height-15,210,6,3);this.timer=setInterval(function(){d--;var a=210*((d+1)/30);var e=6>210*(d/30)?6:210*(d/30);c=b.tweens.addCounter({from:a,to:e,duration:1e3,ease:"Linear",onUpdate:function onUpdate(){if(!b.timeProgress){c.stop();return}b.timeProgress.clear();b.timeProgressBack.clear();b.timeProgress.fillRoundedRect(b.cameras.main.centerX-105,b.cameras.main.height-15,c.getValue(),6,3);b.timeProgressBack.fillRoundedRect(b.cameras.main.centerX-105,b.cameras.main.height-15,210,6,3)}});if(0>d){clearInterval(b.timer);b.timer=null;b.timeProgress.destroy();b.timeProgress=null;b.timeProgressBack.destroy();b.timeProgressBack=null;b.switchTurn()}},1e3)};c.setMoves=function setMoves(a){if(this.moves.includes(a)||0>this.getLastEmptyCell(a[1])||this.gameOver)return;this.moves.push(a);if(this.lastToken)this.lastToken.stopEmitter();this.board[a[0]][a[1]]=this.opponentToken;this.lastToken=this.addToken(this.opponentToken,a[0],a[1]);this.boardTokens[a[0]][a[1]]=this.lastToken};c.switchTurn=function switchTurn(){if(this.gameOver||this.turn!=this.player)return;this.SendGame({type:"turn",turn:this.opponent});this.turn=this.opponent;this.turnText.text="Opponent's turn";if(this.timeProgress){clearInterval(this.timer);this.timer=null;this.timeProgress.destroy();this.timeProgress=null;this.timeProgressBack.destroy();this.timeProgressBack=null}};c.doWin=function doWin(){var a=this;if(this.checkWinner()&&this.checkWinner()==this.playerToken){if(this.timer){clearInterval(this.timer);this.timer=null}setTimeout(function(){a.scene.start("GameOver",{player:a.player,opponent:a.opponent,winner:a.player})},2e3);this.gameOver=!0}};c.doLose=function doLose(){var a=this;if(this.checkWinner()&&this.checkWinner()==this.opponentToken){if(this.timer){clearInterval(this.timer);this.timer=null}setTimeout(function(){a.scene.start("GameOver",{player:a.player,opponent:a.opponent,winner:a.opponent})},2e3);this.gameOver=!0}};c.doDraw=function doDraw(){if(!this.checkWinner()&&this.checkDraw())this.doReset()};c.doQuit=function doQuit(a,b){if(this.opponent==a){if(this.timer){clearInterval(this.timer);this.timer=null;this.timeProgress.destroy();this.timeProgress=null;this.timeProgressBack.destroy();this.timeProgressBack=null}this.doReset();this.switchTurn();this.BootEvents.emit("doReset");this.BootEvents.emit("setReady",!0);this.scene.start("Menu",{player:this.player,quit:b})}};c.doReset=function doReset(){var a=this;if(0<this.tokens.getAll().length){this.board=[[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]];this.boardTokens=[[],[],[],[],[],[]];this.gameOver=!1;this.winTokens=[];this.lastToken=null;this.moves=[];this.tokens.getAll().forEach(function(b){a.tweens.add({targets:b,alpha:0,duration:400,x:a.cameras.main.centerX-31,ease:"Back.easeInOut",onComplete:function onComplete(){b.stopEmitter();b.destroy()}})})}};c.SendGame=function SendGame(a){a.to=this.opponent;a.from=this.player;this.BootEvents.emit("sendGame",a)};c.getLastEmptyCell=function getLastEmptyCell(a){for(var b=5;0<=b;b--){if(0==this.board[b][a])return b}return-1};c.checkWinner=function checkWinner(){return this.checkVertical()||this.checkHorizontal()||this.checkDiagonal()};c.checkDraw=function checkDraw(){for(var a=0;7>a;a++){if(0==this.board[0][a])return!1}return!0};c.checkVertical=function checkVertical(){for(var a=0;3>a;a++){for(var b=0;7>b;b++){if(0!=this.board[a][b]&&this.board[a][b]==this.board[a+1][b]&&this.board[a][b]==this.board[a+2][b]&&this.board[a][b]==this.board[a+3][b]){this.winTokens.push(this.boardTokens[a][b]);this.winTokens.push(this.boardTokens[a+1][b]);this.winTokens.push(this.boardTokens[a+2][b]);this.winTokens.push(this.boardTokens[a+3][b]);return this.board[a][b]}}}return null};c.checkHorizontal=function checkHorizontal(){for(var a=0;6>a;a++){for(var b=0;4>b;b++){if(0!=this.board[a][b]&&this.board[a][b]==this.board[a][b+1]&&this.board[a][b]==this.board[a][b+2]&&this.board[a][b]==this.board[a][b+3]){this.winTokens.push(this.boardTokens[a][b]);this.winTokens.push(this.boardTokens[a][b+1]);this.winTokens.push(this.boardTokens[a][b+2]);this.winTokens.push(this.boardTokens[a][b+3]);return this.board[a][b]}}}return null};c.checkDiagonal=function checkDiagonal(){for(var a=0;4>a;a++){for(var b=0;3>b;b++){if(0!=this.board[b][a]&&this.board[b][a]==this.board[b+1][a+1]&&this.board[b][a]==this.board[b+2][a+2]&&this.board[b][a]==this.board[b+3][a+3]){this.winTokens.push(this.boardTokens[b][a]);this.winTokens.push(this.boardTokens[b+1][a+1]);this.winTokens.push(this.boardTokens[b+2][a+2]);this.winTokens.push(this.boardTokens[b+3][a+3]);return this.board[b][a]}}for(var c=3;6>c;c++){if(0!=this.board[c][a]&&this.board[c][a]==this.board[c-1][a+1]&&this.board[c][a]==this.board[c-2][a+2]&&this.board[c][a]==this.board[c-3][a+3]){this.winTokens.push(this.boardTokens[c][a]);this.winTokens.push(this.boardTokens[c-1][a+1]);this.winTokens.push(this.boardTokens[c-2][a+2]);this.winTokens.push(this.boardTokens[c-3][a+3]);return this.board[c][a]}}}return null};return b}(Phaser.Scene);
