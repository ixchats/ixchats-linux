var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var Bot=function(){function a(b){_classCallCheck(this,a),this.checkOkToRun=this.checkOkToRun.bind(this),this.fnSignin=this.fnSignin.bind(this),this.noUsersChange=this.noUsersChange.bind(this),this.saveBotSettings=this.saveBotSettings.bind(this),this.loadBotSettings=this.loadBotSettings.bind(this),this.login=this.login.bind(this),this.sendCanvasTo=this.sendCanvasTo.bind(this),this.tx=this.sendCanvasTo,this.rx=b.onRx,addEventListener('message',this.onMessage.bind(this)),b.chatName&&(this.chatName=b.chatName,this.botName=b.botName,this.regName=b.regName,this.id=b.id,this.apiKey=b.apiKey),this.loadc=0,this.Real=!1,this.useDummys=!0,this.websocket=null,this.invited,this.isDone=!1,this.users={},this.params=['debugUsers','chatName','regName','apiKey','botName'],this.Node||this.initGUI(),this.Real&&this.login()}return a.prototype.createWebSocket=function createWebSocket(a){this.websocket=new WebSocket('wss://wss2.xatbox.com:443/v2appbot'),this.websocket.binaryType='arraybuffer',this.websocket.onopen=function(){console.log('WebSocket opened ok'),a()},this.websocket.onclose=function(a){console.log('WebSocket closed with error: ',a.code)},this.websocket.onerror=function(){console.log('WebSocket error')}},a.prototype.onSocketMessage=function onSocketMessage(a){this.websocket.onmessage=function(b){return a(Bytes.fromArrayBuffer(b.data))}},a.prototype.login=function login(){var a=this;fetch('https://xat.com/api/roomid.php?d='+this.chatName.toLowerCase()).then(function(a){return a.json()}).then(function(b){a.roomId=b.id,a.createWebSocket(function(){a.websocket.send(PacketUtils.buildPacket('y',{r:'2',v:0,u:1001})),a.onSocketMessage(function(b){var c=PacketUtils.parsePacket(b);switch(c.node){case'y':a.websocket.send(PacketUtils.buildPacket('v',{n:a.regName,a:a.apiKey}));break;case'v':a.loginPacket=c.elements,a.loginPacket.i&&(a.id=a.loginPacket.i),a.loginPacket.n&&(a.regName=a.loginPacket.n),a.connect(a.roomId);}})})})},a.prototype.connect=function connect(a){var b=this;this.createWebSocket(function(){b.websocket.send(PacketUtils.buildPacket('y',{r:a,m:1,v:0,u:b.loginPacket.i})),b.onSocketMessage(function(c){var d=PacketUtils.parsePacket(c),e={cb:new Date().getTime(),l5:'65535',l4:'500',l3:'500',l2:'0',y:d.elements.i,k:b.loginPacket.k1,k3:b.loginPacket.k3};e.z='m1.5.12,3',b.loginPacket.d1&&(e.d1=b.loginPacket.d1),Object.assign(e,{p:'0',c:a,f:'0',u:b.loginPacket.i,d0:b.loginPacket.d0});for(var f,g=2;40>g;g++)f='d'+g,b.loginPacket[f]&&(e[f]=b.loginPacket[f]);b.loginPacket.dO&&(e.dO=b.loginPacket.dO),b.loginPacket.dx&&(e.dx=b.loginPacket.dx),b.loginPacket.dt&&(e.dt=b.loginPacket.dt),Object.assign(e,{N:b.regName,n:b.botName,a:'(appbot)',h:'http://xat.com',v:''}),b.websocket.send(PacketUtils.buildPacket('j2',e)),b.onSocketMessage(function(a){return b.handleOnlinePackets(a)})})})},a.prototype.handleOnlinePackets=function handleOnlinePackets(a){var b=PacketUtils.parsePacket(a);switch(b.node){case'm':if(!this.isDone)break;b.action='message',this.rxmessage?this.rxmessage(this.xInt(b.elements.u),b):this.rx(this.xInt(b.elements.u),b);break;case'u':try{var c=parseInt(b.elements.u);this.users[c]||(this.users[c]={});var d=this.users[c];d.regname=b.elements.N.toLowerCase()||null,d.avatar=b.elements.a,d.name=b.elements.n.split('(')[0].trim().replace(/_/g,'')}catch(a){}break;case'done':this.isDone=!0,this.checkOkToRun();break;case'l':{try{var e=parseInt(b.elements.u);delete this.users[e]}catch(a){}break}case'x':var f=LZString.decompressFromBase64(b.elements.t),g=JSON.parse(f);this.rx(this.xInt(b.elements.u),g);}},a.prototype.onMessage=function onMessage(a){try{var b=JSON.parse(a.data);if(1==b.channel)return;if(b.o)this.sendCanvasTo(b.u,b.o);else if(60002==b.channel&&b.msg){var c=JSON.parse(LZString.decompressFromBase64(b.msg));this.rx(b.user,c)}}catch(a){}},a.prototype.sendCanvasTo=function sendCanvasTo(a,b){if(a instanceof Array){for(var f in a)this.sendCanvasTo(a[f],b);return}console.log('apptx:',a,b);var c=parseInt(a),d=JSON.stringify(b),e=LZString.compressToBase64(d);if(3e3<e.length){if(!(b instanceof Array))console.error('tx:','single obj is too big',d);else if(1==b.length)this.sendCanvasTo(a,b[0]);else{var g=Math.floor(b.length/2);this.sendCanvasTo(a,b.slice(0,g)),this.sendCanvasTo(a,b.slice(g))}return}if(this.dummys&&(!c||this.dummys[c])){var h=this.dummys;c&&(h={},h[c]=!0);var i=JSON.stringify({channel:60002,msg:e});for(var j in h)try{var k=this.dummys[j].frame;k.contentWindow.postMessage(i,'*')}catch(a){}}if(this.websocket)try{this.websocket.send(PacketUtils.buildPacket('x',{i:60002,d:c,u:this.id,t:e}))}catch(a){}},a.prototype.sendMessage=function sendMessage(a){if(console.log('%c BOT MESSAGE: '+a,'background: #059C0A; color: white; font-size: 16px;'),this.websocket)try{this.websocket.send(PacketUtils.buildPacket('m',{t:a,u:this.id}))}catch(a){}},a.prototype.disconnect=function disconnect(){this.websocket.close(),this.websocket=null},a.prototype.xInt=function xInt(b){return b=parseInt(b),isNaN(b)?0:b},a.prototype.checkOkToRun=function checkOkToRun(){this.loadc--,0==this.loadc&&this.rx(0,{action:'main'})},a.prototype.initGUI=function initGUI(){document.body.innerHTML='\n      <div id=\'signinDiv\'>\n        <h3>xat app development</h3><BR>\n        <form id="signinForm">\n          <label for="debugUsers">Debug/Test/Fake users:</label>\n          <input id="debugUsers" type="number" min="1" max="10" step="1" placeholder="number of debug users (1 or 2)"><BR><BR>\n          <label for="chatName">chat name:</label>\n          <input id="chatName" type="text" placeholder="chat name to send your bot">\n          <label for="regName">regName:</label>\n          <input id=\'regName\' type="text" placeholder="registered name of your bot">\n          <label for="apiKey">apikey: (from xat login page)<!--(see <a href=\'\'>wiki</a>)--></label>\n          <input id="apiKey" type="text" placeholder="your bot\'s api key">\n          <label for="botName">name for bot:</label>\n          <input id="botName" type="text" placeholder="name your bot will have on the chat">\n          <input type="submit" value="Run appbot on chat">\n          <!-- <p>config is saved in localStorage</p> -->\n        </form>\n    </div>\n',this.loadBotSettings(),this.loadDebugCanvases(),document.getElementById('signinForm').addEventListener('submit',this.fnSignin),document.getElementById('debugUsers').addEventListener('change',this.noUsersChange)},a.prototype.addDebugCanvas=function addDebugCanvas(a){var b=document.createElement('iframe');document.body.appendChild(b),this.dummys[a]={frame:b},this.users[a]={},this.users[a].regname='User'+a,this.users[a].avatar=a,this.users[a].name='Name'+a,b.id=a+'_iframe',b.width=425,b.height=600,b.className='canvasFrame',b.src='https://xat.com/content/temp/canvas.html?'+a+'&z1',this.loadc++,b.addEventListener('load',this.checkOkToRun)},a.prototype.loadDebugCanvases=function loadDebugCanvases(){this.dummys={};var a=document.getElementById('debugUsers');a=a?a.value:1,(!a||0>a||10<a)&&(a=1);for(var b=0;b<a;b++)this.addDebugCanvas(b+101)},a.prototype.fnSignin=function fnSignin(a){for(var b in a.preventDefault(),this.saveBotSettings(),this.loadBotSettings(),this.dummys)this.dummys[b].frame.remove(),delete this.dummys[b],delete this.users[b];this.Real=!0,this.loadc=1,this.login()},a.prototype.noUsersChange=function noUsersChange(a){a.preventDefault(),this.saveBotSettings();var b=document.getElementById('debugUsers'),c=b.value;if(!(10<c)&&!(0>c))for(var f,g=0;10>g;g++){if(f=Object.keys(this.dummys),c==f.length)return;if(c<f.length){var h=f[f.length*Math.random()<<0];this.dummys[h].frame.remove(),delete this.dummys[h],delete this.users[h]}else{for(var d=void 0,e=101;111>=e;e++)if(!this.dummys[e]){d=e;break}d&&this.addDebugCanvas(d)}}},a.prototype.loadBotSettings=function loadBotSettings(){try{var a=localStorage.getItem('appbot'),b=JSON.parse(a);for(var c in this.params){var d=document.getElementById(this.params[c]);d&&b[this.params[c]]&&(d.value=this[this.params[c]]=b[this.params[c]])}}catch(a){var e=document.getElementById('debugUsers');e.value=1}},a.prototype.saveBotSettings=function saveBotSettings(){try{var a={};for(var b in this.params){var c=document.getElementById(this.params[b]);c&&(a[this.params[b]]=c.value?c.value:'')}localStorage.setItem('appbot',JSON.stringify(a))}catch(a){}},a}(),Bytes={fromArrayBuffer:function fromArrayBuffer(e){for(var f='',g=new Uint8Array(e),h=g.byteLength,j=h%3,k=h-j,l=void 0,a=void 0,b=void 0,c=void 0,d=void 0,m=0;m<k;m+=3)d=g[m]<<16|g[m+1]<<8|g[m+2],l=(16515072&d)>>18,a=(258048&d)>>12,b=(4032&d)>>6,c=63&d,f+='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[l]+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[a]+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[b]+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[c];return 1==j?(d=g[k],l=(252&d)>>2,a=(3&d)<<4,f+='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[l]+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[a]+'=='):2==j&&(d=g[k]<<8|g[k+1],l=(64512&d)>>10,a=(1008&d)>>4,b=(15&d)<<2,f+='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[l]+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[a]+'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'[b]+'='),atob(f)},toArrayBuffer:function toArrayBuffer(a){for(var b,c=[],d=0;d<a.length;d++)b=a.charCodeAt(d),128>b?c.push(b):2048>b?c.push(192|b>>6,128|63&b):55296>b||57344<=b?c.push(224|b>>12,128|63&b>>6,128|63&b):(d++,b=65536+((1023&b)<<10|1023&a.charCodeAt(d)),c.push(240|b>>18,128|63&b>>12,128|63&b>>6,128|63&b));for(var e=c.length,f=new ArrayBuffer(e),g=new Uint8Array(f),h=0;h<e;h++)g[h]=c[h];return f}},Lib=function(){function a(b){_classCallCheck(this,a),this.Messages=this.Messages.bind(this),b&&('object'===('undefined'==typeof b?'undefined':_typeof(b))&&(this.bot=b.bot),b instanceof Bot&&(this.bot=b))}return a.prototype.Version=function Version(){return 1},a.prototype.Background=function Background(a,b){return b=b?600:425,{name:'background',type:'Sprite',imageUrl:'url',anchor:{x:0,y:0},width:b,height:600}},a.prototype.AddText=function AddText(a,b,c,d){return{name:a,type:'Text',text:b,x:c,y:d}},a.prototype.Delete=function Delete(a){return{name:a,destroy:!0}},a.prototype.DeleteChildren=function DeleteChildren(a){return{name:a,destroyChildren:!0}},a.prototype.xInt=function xInt(b){return b=parseInt(b),isNaN(b)?0:b},a.prototype.Init=function Init(a){this.bot.sendCanvasTo(0,[{name:'game',destroyChildren:!0},{name:'game',y:20,type:'Container'}]),a&&(a.Commands&&(this.bot.rxmessage=this.Messages),'on'==a.Invite&&!this.bot.invited&&(this.bot.invited={}))},a.prototype.Messages=function Messages(a,b){if('message'==b.action){var c,d,e=b.elements.t;if(e&&'@'==e.charAt(0))switch(e=e.toLowerCase().substr(1).split(' '),e[0]){case'start':this.bot.rx(0,{action:'main'});break;case'add':case'invite':if('off'==e[1])return void delete this.bot.invited;if(this.bot.invited||(this.bot.invited={}),d=this.xInt(e[1]),d&&this.bot.users[d])return void(this.bot.invited[d]=!0);for(c in d=e[1].toLowerCase(),this.bot.users)if(d==this.bot.users[c].regname)return void(this.bot.invited[c]=!0);this.bot.sendMessage(e[1].replace(/[^A-Za-z0-9_]/g,'')+' not in the chat');break;case'remove':case'uninvite':if(!this.bot.invited)return;if(d=this.xInt(e[1]),d&&this.bot.invited[d])return void delete this.bot.invited[d];for(c in d=e[1].toLowerCase(),this.bot.users)if(d==this.bot.users[c].regname)return void delete this.bot.invited[c];break;case'list':var f='';if(!this.bot.invited)f='Invites are off';else{for(d in this.bot.invited)f+=(this.bot.users[d].regname?this.bot.users[d].regname:d)+' ';f=f?'Invited users: '+f:'No invited users'}this.bot.sendMessage(f);}}},a.prototype.GetMs=function GetMs(){return new Date().getTime()},a.prototype.StartRaceGame=function StartRaceGame(){for(var a in this.StartRaceTime=this.GetMs(),this.bot.users)this.bot.users[a].FinshTime=0;this.Places=[]},a.prototype.UserFinishedGame=function UserFinishedGame(a){if(a=this.xInt(a),!!this.StartRaceTime){this.Places||(this.Places=[]);var b=this.bot.users[a];b&&(b.FinshTime=this.GetMs()-this.StartRaceTime,this.Places.push(a))}},a.prototype.SendLeaderBoard=function SendLeaderBoard(a){var b=[{name:'leader_container',type:'Container',parent:'game'},{name:'leaderboard',type:'Graphics',parent:'leader_container',commands:[['lineStyle',2,5422322,2],['beginFill',35071,1],['drawRoundedRect',40,100,350,400,15],['endFill']]},{name:'leaderboard_style',type:'TextStyle',parent:'leader_container',style:{fill:'#ffFFFF',fontSize:17}},{name:'leaderboard_text',type:'Text',text:'LEADERBOARD - TOP 4 PLAYERS',parent:'leader_container',x:220,y:120,style:'leaderboard_style'},{name:'leaderboard_style_name',type:'TextStyle',parent:'leader_container',style:{fill:'#ffFFFF',fontSize:15}}],c=['\uD83E\uDD47 1st','\uD83E\uDD48 2nd','\uD83E\uDD49 3rd'];for(var e in this.Places)if(4>e){var d=this.Places[e],f=this.xInt(this.bot.users[d].FinshTime/100)/10;b.push({name:'place'+e,type:'Text',text:(void 0==c[e]?'Place '+(e+1):c[e])+': '+this.bot.users[d].regname+' ('+f+' seconds)',x:210,y:200+45*e,parent:'leader_container',style:'leaderboard_style_name'})}this.bot.sendCanvasTo(a?0:this.Places,b)},a}(),PacketUtils={parsePacket:function parsePacket(a){console.log('Received: '+a);for(var b={node:'',elements:{}},c=a.toString().match(/<([\w]+)[^>]*>/g),d=c,e=Array.isArray(d),f=0,d=e?d:d[Symbol.iterator]();;){var g;if(e){if(f>=d.length)break;g=d[f++]}else{if(f=d.next(),f.done)break;g=f.value}var h=g;parser=new DOMParser,xmlDoc=parser.parseFromString(h,'text/xml'),b.node=xmlDoc.documentElement.nodeName,Object.keys(xmlDoc.documentElement.attributes).forEach(function(a){b.elements[xmlDoc.documentElement.attributes[a].nodeName]=xmlDoc.documentElement.attributes[a].nodeValue})}return b},buildPacket:function buildPacket(a,b){for(var c='<'+a,d=Object.keys(b),e=Array.isArray(d),f=0,d=e?d:d[Symbol.iterator]();;){var g;if(e){if(f>=d.length)break;g=d[f++]}else{if(f=d.next(),f.done)break;g=f.value}var h=g,i=b[h];c+=' '+h+'="'+i+'"'}return c+=' />\0',console.log('Sent: '+c),c}},User=function a(b){_classCallCheck(this,a),this.registeredName=b.elements.N||null,this.avatar=b.elements.a,this.name=b.elements.n.split('(')[0].trim().replace(/_/g,''),this.id=b.elements.u.replace(/_[0-9]+/,'')},FakeUser=function a(b,c){_classCallCheck(this,a),this.id=b,this.registeredName=c},UserManager=function(){function a(b){_classCallCheck(this,a),this.bot=b,this.users=[]}return a.prototype.addUser=function addUser(a){this.users.push(new User(a))},a.prototype.addFakeUser=function addFakeUser(a,b){this.users.push(new FakeUser(a,b))},a.prototype.removeUser=function removeUser(a){var b=this.findUser(a);this.users.splice(this.users.indexOf(b),1)},a.prototype.findUser=function findUser(a){for(var b=this.users,c=Array.isArray(b),d=0,b=c?b:b[Symbol.iterator]();;){var e;if(c){if(d>=b.length)break;e=b[d++]}else{if(d=b.next(),d.done)break;e=d.value}var f=e;if(f.registeredName)if('number'!=typeof a){if(f.id===a||f.registeredName.toLowerCase()===a.toLowerCase())return f;if(f.id===a)return f}else if(f.id===a)return f}return null},a}();function loadScript(a){var b=document.createElement('script');b.type='text/javascript',b.src=a,document.body.appendChild(b)}function decodeId(a){return a.split('_')[0]}function shuffleArray(b){var a,c,d;for(d=b.length-1;0<d;d--)a=Math.floor(Math.random()*(d+1)),c=b[d],b[d]=b[a],b[a]=c;return b}function capitalize(a){return a.charAt(0).toUpperCase()+a.slice(1)}function clearElements(a,b){return(a||(a=0),elements.length==a)?(elements=[],b?b():void 0):(sendCommand({name:elements[a],destroy:!0}),a++,setTimeout(clearElements,50,a,b))}function findUserInArrayById(a,b){for(var c=a,d=Array.isArray(c),e=0,c=d?c:c[Symbol.iterator]();;){var f;if(d){if(e>=c.length)break;f=c[e++]}else{if(e=c.next(),e.done)break;f=e.value}var g=f;if(g.id===b)return g}return null}function getRandomFromArray(a){return a[Math.floor(Math.random()*a.length)]}function setupDevEnvironment(a){a.loaded=0;var b=localStorage.getItem(a.constructor.name),c=JSON.parse(b);if(c||(c={},c.fakes=2,c.mode='dev'),'dev'===c.mode)for(var d=0;d<c.fakes;d++)a.processInvite(['',FAKEUSERS[d][1]+'Fake']);document.addEventListener('DOMContentLoaded',function(){for(var b=a.players,c=Array.isArray(b),d=0,b=c?b:b[Symbol.iterator]();;){var e;if(c){if(d>=b.length)break;e=b[d++]}else{if(d=b.next(),d.done)break;e=d.value}var f=e,g=document.createElement('div');g.id='canvas_instance';var h=document.createElement('iframe');h.id=f.id,h.className='appFrame',h.src='../../canvas/canvas.html?'+f.id;var i=document.createElement('h1');i.className='canvas_title',i.innerHTML=f.registeredName+'\'s Canvas',g.appendChild(i),g.appendChild(h),document.querySelector('#canvas_container').appendChild(g)}}),createDebugListeners(a)}function createDebugListeners(a){window.addEventListener('message',function(b){var c=JSON.parse(b.data);if(60002==c.channel){var d=JSON.parse(LZString.decompressFromBase64(c.msg));a.packetHandler(d,{elements:{i:0,u:c.user}})}},!1)}function pixiRequirementsMet(a,b){return!!(a&&a.name&&b&&b.elements.u)}function arrayToChunks(a,b){for(var c=[],d=0,e=a.length;d<e;)c.push(a.slice(d,d+=b));return c}function findUserIndex(a,b){for(var c in a.players)if(a.players[c]===b)return c;return!1}function registerTimer(){}
